<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>学習トロッコゲーム</title>
<style>
/* === 全体の設定 === */
body {
    margin: 0;
    background: #000;
    overflow: hidden;
    height: 100vh;
    font-family: 'Hiragino Kaku Gothic ProN', 'メイリオ', sans-serif;
    touch-action: manipulation;
}

/* === 3Dシーン（背景） === */
.scene {
    position: fixed;
    top: 0; left: 0;
    width: 100%;
    height: 100%;
    perspective: 300px;
    overflow: hidden;
    z-index: 1;
}

/* カメラの揺れコンテナ */
.camera-shake {
    width: 100%;
    height: 100%;
    transform-style: preserve-3d;
    animation: shake 0.15s infinite linear;
}

/* 世界の中心位置 */
.world {
    position: absolute;
    top: 50%;
    left: 50%;
    transform-style: preserve-3d;
    transition: transform 0.3s ease-out;
}

/* 壁・床の共通設定 */
.surface {
    position: absolute;
    backface-visibility: hidden;
}

/* 床（レール） */
.floor {
    width: 600px; height: 4000px;
    transform: translate(-50%, -50%) rotateX(90deg) translateZ(-150px);
    background-image: url('rail.png');
    background-repeat: repeat-y; background-size: 100% auto;
    animation: moveFloor 0.8s linear infinite;
}

/* 壁（左右） */
.wall {
    width: 4000px; height: 600px;
    top: 50%; left: 50%;
    background-image: url('wall_post.png');
    background-repeat: repeat-x; background-size: auto 100%;
}
.wall-left {
    transform: translate(-50%, -50%) rotateY(90deg) translateZ(-300px);
    animation: moveWallLeft 0.8s linear infinite;
}
.wall-right {
    transform: translate(-50%, -50%) rotateY(-90deg) translateZ(-300px);
    animation: moveWallRight 0.8s linear infinite;
}

/* 天井 */
.ceiling {
    width: 600px; height: 4000px;
    transform: translate(-50%, -50%) rotateX(90deg) translateZ(150px);
    background: #111;
}

/* 奥のフォグ */
.fog {
    position: absolute; top: 0; left: 0;
    width: 100%; height: 100%;
    background: radial-gradient(circle, transparent 30%, #000 90%);
    z-index: 10;
    pointer-events: none;
}


/* === ゲームUIレイヤー（手前） === */
#game-ui {
    position: fixed;
    top: 0; left: 0;
    width: 100%; height: 100%;
    z-index: 100;
    display: flex;
    flex-direction: column;
    justify-content: space-between;
    align-items: center;
    padding: 20px;
    box-sizing: border-box;
    pointer-events: none;
}

/* 看板 */
#question-board {
    background: rgba(60, 40, 20, 0.9);
    border: 4px solid #5a3c28;
    border-radius: 10px;
    padding: 20px;
    color: #fff;
    text-align: center;
    max-width: 80%;
    box-shadow: 0 4px 8px rgba(0,0,0,0.5);
    pointer-events: auto;
}
#question-text { font-size: 1.5em; margin-bottom: 10px; font-weight: bold; }
#question-image { max-width: 100%; max-height: 150px; display: none; margin: 0 auto 10px; border-radius: 5px; }

/* 選択肢エリア */
#choices-container {
    display: flex;
    justify-content: space-around;
    width: 100%;
    margin-bottom: 40px;
    pointer-events: auto;
}

/* ボタン */
.choice-btn {
    background: linear-gradient(to bottom, #ffcc00, #ff9900);
    border: 3px solid #fff;
    border-radius: 15px;
    padding: 15px 30px;
    color: #330;
    font-size: 1.2em;
    font-weight: bold;
    cursor: pointer;
    text-align: center;
    width: 40%;
    box-shadow: 0 6px 0 #cc6600, 0 8px 10px rgba(0,0,0,0.3);
    transition: all 0.1s;
}
.choice-btn:active {
    transform: translateY(4px);
    box-shadow: 0 2px 0 #cc6600, 0 4px 6px rgba(0,0,0,0.3);
}
.choice-image { max-width: 80px; max-height: 80px; display: block; margin: 0 auto 5px; }

/* === フィードバック === */
.overlay {
    position: fixed; top: 0; left: 0; width: 100%; height: 100%;
    display: flex; justify-content: center; align-items: center;
    z-index: 200;
    pointer-events: none;
    opacity: 0; transition: opacity 0.3s;
}
#feedback-mark { font-size: 20em; font-weight: bold; }
.correct-mark { color: #00ff00; text-shadow: 0 0 20px #00ff00; }
.incorrect-mark { color: #ff0000; text-shadow: 0 0 20px #ff0000; }

#gameover-overlay {
    background: rgba(0,0,0,0.85);
    flex-direction: column;
    color: #fff;
    pointer-events: auto;
    cursor: pointer;
}
#gameover-overlay h1 { font-size: 4em; color: #ff3333; margin: 0; }
#gameover-overlay p { font-size: 1.5em; }

/* === アニメーション === */
@keyframes moveFloor { from { background-position: 0 0; } to { background-position: 0 1000px; } }
@keyframes moveWallLeft { from { background-position: 0 0; } to { background-position: -1000px 0; } }
@keyframes moveWallRight { from { background-position: 0 0; } to { background-position: 1000px 0; } }
@keyframes shake {
    0% { transform: translate(0,0) rotate(0deg); }
    25% { transform: translate(2px,2px) rotate(0.3deg); }
    50% { transform: translate(-2px,-2px) rotate(-0.3deg); }
    75% { transform: translate(-2px,2px) rotate(0.2deg); }
}

/* === 状態変化 === */
.branch-left .world { transform: translate(50%, 50%) rotateY(20deg) translateZ(-100px); }
.branch-right .world { transform: translate(-50%, 50%) rotateY(-20deg) translateZ(-100px); }
.stopped .surface, .stopped .camera-shake { animation-play-state: paused !important; }
.falling .scene { transition: transform 1s ease-in; transform: translateY(1000px) rotateX(-30deg); }

</style>
</head>
<body>

<div class="scene" id="scene">
    <div class="camera-shake" id="camera">
        <div class="world" id="world">
            <div class="ceiling surface"></div>
            <div class="floor surface"></div>
            <div class="wall wall-left surface"></div>
            <div class="wall wall-right surface"></div>
        </div>
    </div>
    <div class="fog"></div>
</div>

<div id="game-ui">
    <div id="question-board">
        <img id="question-image" src="" alt="問題画像">
        <div id="question-text">データを読み込んでいます...</div>
    </div>

    <div id="choices-container">
        <button class="choice-btn" id="btn-left" onclick="answer('left')">
            <img class="choice-image" id="img-left" src="" style="display:none;">
            <span id="text-left">ひだり</span>
        </button>
        <button class="choice-btn" id="btn-right" onclick="answer('right')">
            <img class="choice-image" id="img-right" src="" style="display:none;">
            <span id="text-right">みぎ</span>
        </button>
    </div>
</div>

<div id="feedback-overlay" class="overlay">
    <div id="feedback-mark"></div>
</div>

<div id="gameover-overlay" class="overlay" onclick="restartGame()">
    <h1>GAME OVER</h1>
    <p>クリックして最初からやりなおす</p>
</div>

<audio id="se-correct" src="correct.wav"></audio>
<audio id="se-fall" src="fall.mp3"></audio>

<script>
// === 設定 ===
// 元のスプレッドシートURL
const GOOGLE_SHEET_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vTV8WBoJ2XjuwHLZeZvQky5nzV4M_Ew1QD8KJ9U4Bk2DzhWp0FVaUr0xrQqj8zprGfgchA2GT4NhXsi/pub?output=csv';

// 【修正】CORS制限を回避するためのプロキシURL経由にする
const PROXY_URL = 'https://api.allorigins.win/raw?url=' + encodeURIComponent(GOOGLE_SHEET_URL);

let questions = [];
let currentIndex = 0;
let isAnswering = false;

const uiContainer = document.getElementById('game-ui');
const qText = document.getElementById('question-text');
const qImage = document.getElementById('question-image');
const lText = document.getElementById('text-left');
const lImage = document.getElementById('img-left');
const rText = document.getElementById('text-right');
const rImage = document.getElementById('img-right');
const scene = document.getElementById('scene');
const camera = document.getElementById('camera');
const world = document.getElementById('world');
const feedbackOverlay = document.getElementById('feedback-overlay');
const feedbackMark = document.getElementById('feedback-mark');
const gameoverOverlay = document.getElementById('gameover-overlay');
const seCorrect = document.getElementById('se-correct');
const seFall = document.getElementById('se-fall');

window.onload = function() {
    loadCSV();
    // 音声の事前ロード（ダミー再生）
    document.body.addEventListener('click', function() {
        seCorrect.play().catch(()=>{}); seCorrect.pause();
        seFall.play().catch(()=>{}); seFall.pause();
    }, { once: true });
};

function loadCSV() {
    // 修正：プロキシURLを使って取得
    fetch(PROXY_URL)
        .then(response => {
            if (!response.ok) throw new Error('Network response was not ok');
            return response.text();
        })
        .then(text => {
            questions = parseCSV(text);
            if (questions.length > 0) {
                startGame();
            } else {
                qText.textContent = "問題データがありません。";
            }
        })
        .catch(error => {
            console.error('Error loading CSV:', error);
            // エラー時のメッセージを少し分かりやすく
            qText.innerHTML = "データの読み込みに失敗しました。<br>インターネット接続を確認してください。";
        });
}

function parseCSV(text) {
    const lines = text.trim().split('\n');
    const data = [];
    for (let i = 1; i < lines.length; i++) {
        const line = lines[i].trim();
        if (line === "") continue;
        const cols = line.split(',');
        data.push({
            qText: cols[0] || "",
            qImg: cols[1] || "",
            lText: cols[2] || "ひだり",
            lImg: cols[3] || "",
            rText: cols[4] || "みぎ",
            rImg: cols[5] || "",
            answer: (cols[6] || "").trim().toLowerCase()
        });
    }
    return data;
}

function startGame() {
    currentIndex = 0;
    resetSceneState();
    showQuestion();
}

function resetSceneState() {
    camera.classList.remove('stopped');
    scene.classList.remove('falling');
    world.classList.remove('branch-left', 'branch-right');
    gameoverOverlay.style.opacity = 0;
    gameoverOverlay.style.pointerEvents = "none";
    uiContainer.style.opacity = 1;
}

function showQuestion() {
    if (currentIndex >= questions.length) {
        currentIndex = 0; // ループ
    }
    const q = questions[currentIndex];
    qText.textContent = q.qText;
    setupImage(qImage, q.qImg);
    lText.textContent = q.lText;
    setupImage(lImage, q.lImg);
    rText.textContent = q.rText;
    setupImage(rImage, q.rImg);
    isAnswering = true;
    uiContainer.style.opacity = 1;
}

function setupImage(imgElement, src) {
    if (src) {
        imgElement.src = src;
        imgElement.style.display = "block";
    } else {
        imgElement.style.display = "none";
    }
}

function answer(direction) {
    if (!isAnswering) return;
    isAnswering = false;
    uiContainer.style.opacity = 0;
    if (direction === 'left') {
        world.classList.add('branch-left');
    } else {
        world.classList.add('branch-right');
    }
    setTimeout(() => {
        checkAnswer(direction);
    }, 600);
}

function checkAnswer(selectedDir) {
    const correctDir = questions[currentIndex].answer;
    
    if (selectedDir === correctDir) {
        seCorrect.currentTime = 0;
        seCorrect.play().catch(e => console.log("音声再生エラー:", e));
        showFeedback(true);
        setTimeout(() => {
            world.classList.remove('branch-left', 'branch-right');
        }, 500);
        setTimeout(() => {
            currentIndex++;
            showQuestion();
        }, 2000);
    } else {
        seFall.currentTime = 0;
        seFall.play().catch(e => console.log("音声再生エラー:", e));
        showFeedback(false);
        setTimeout(() => {
            camera.classList.add('stopped');
            scene.classList.add('falling');
        }, 500);
        setTimeout(() => {
            gameoverOverlay.style.opacity = 1;
            gameoverOverlay.style.pointerEvents = "auto";
        }, 2500);
    }
}

function showFeedback(isCorrect) {
    feedbackMark.textContent = isCorrect ? '〇' : '×';
    feedbackMark.className = isCorrect ? 'correct-mark' : 'incorrect-mark';
    feedbackOverlay.style.opacity = 1;
    setTimeout(() => {
        feedbackOverlay.style.opacity = 0;
    }, 1500);
}

function restartGame() {
    startGame();
}
</script>
</body>
</html>

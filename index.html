<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ニックネーム確認</title>
    <link rel="stylesheet" href="styles.css">
</head>
<body class="blur-background">
    <h1>ようこそ！</h1>

    <!-- 登録済みユーザー -->
    <section style="text-align: center;">
        <p>すでにコバリアンのひと：</p>
        <input type="text" id="nicknameInput" placeholder="ニックネームを入力">
        <button id="checkNickname">ふりかえりへ</button>
    </section>

    <hr>

    <!-- 新規登録ユーザー -->
    <section style="text-align: center;">
        <p>初めてのひと：</p>
        <input type="text" id="newNicknameInput" placeholder="新しく使いたいニックネーム">
        <button id="registerNickname">始める</button>
    </section>

    <p id="statusMessage"></p>

    <script>
        const gasUrl = 'https://script.google.com/macros/s/AKfycbyuGrOaIB4_xouWjfzSFBG5vKOiUlFJsgn1dEnNV6PGsrlfwUSmGHyyLtMC3e6JxME/exec';

        // 登録済みユーザーのニックネーム確認
        document.getElementById('checkNickname').addEventListener('click', async () => {
            const nickname = document.getElementById('nicknameInput').value.trim();
            const status = document.getElementById('statusMessage');

            if (!nickname) {
                status.textContent = 'ニックネームを入力してください。';
                status.style.color = 'red';
                return;
            }

            status.textContent = 'かくにん中...';
            status.style.color = 'black';

            try {
                const response = await fetch(`${gasUrl}?action=getKeywords&nickname=${encodeURIComponent(nickname)}`);
                const data = await response.json();

                if (data.status === 'success' && data.keywords.length > 0) {
                    localStorage.setItem('nickname', nickname);
                    window.location.href = 'reflection.html';
                } else {
                    status.textContent = 'もしかして初めて？下の四角にニックネームを入れてね。';
                    status.style.color = 'red';
                }
            } catch (error) {
                status.textContent = '確認中にエラーが発生しました。';
                status.style.color = 'red';
                console.error(error);
            }
        });

        // 新規登録
        document.getElementById('registerNickname').addEventListener('click', async () => {
            const newNickname = document.getElementById('newNicknameInput').value.trim();
            const status = document.getElementById('statusMessage');

            if (!newNickname) {
                status.textContent = '新しいニックネームを入力してください。';
                status.style.color = 'red';
                return;
            }

            status.textContent = '登録確認中...';
            status.style.color = 'black';

            try {
                const checkResponse = await fetch(`${gasUrl}?action=getKeywords&nickname=${encodeURIComponent(newNickname)}`);
                const checkData = await checkResponse.json();

                if (checkData.status === 'success' && checkData.keywords.length === 0) {
                    // 新しいニックネームとして保存
                    const saveResponse = await fetch(gasUrl, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'text/plain;charset=utf-8'
                        },
                        body: JSON.stringify({
                            action: 'saveKeyword',
                            nickname: newNickname,
                            keyword: '初回登録'
                        })
                    });

                    const saveData = await saveResponse.json();

                    if (saveData.status === 'success') {
                        localStorage.setItem('nickname', newNickname);
                        window.location.href = 'reflection.html';
                    } else {
                        status.textContent = '登録に失敗しました。';
                        status.style.color = 'red';
                    }
                } else {
                    status.textContent = 'このニックネームは既に使われています。別の名前にしてください。';
                    status.style.color = 'red';
                }
            } catch (error) {
                status.textContent = '登録処理中にエラーが発生しました。';
                status.style.color = 'red';
                console.error(error);
            }
        });
    </script>
</body>
</html>
